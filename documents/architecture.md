# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ä¼šè©±ãƒ€ãƒƒã‚·ãƒ¥ã®æŠ€è¡“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã€ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã€API è¨­è¨ˆã«ã¤ã„ã¦å®šç¾©ã—ã¾ã™ã€‚

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     client (Next.js)                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Frontend    â”‚   â”‚ Server       â”‚   â”‚ Client      â”‚   â”‚
â”‚  â”‚              â”‚   â”‚ Components   â”‚   â”‚ Components  â”‚   â”‚
â”‚  â”‚  (React)     â”‚   â”‚              â”‚   â”‚             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                  â”‚                  â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                            â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   Server Actions â”‚  â”‚  API Routes   â”‚
          â”‚   (Mutations)    â”‚  â”‚  (Webhooks)   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OpenAI API                 â”‚  â”‚   Local Storage        â”‚
â”‚     (GPT-4o-mini)              â”‚  â”‚                        â”‚
â”‚                                â”‚  â”‚  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿        â”‚
â”‚  - ä¼šè©±ç”Ÿæˆ                     â”‚  â”‚  - ãƒ—ãƒ¬ã‚¤å±¥æ­´           â”‚
â”‚  - è©•ä¾¡                        â”‚  â”‚  - ç§°å·ãƒ»ãƒ¬ãƒ™ãƒ«          â”‚
â”‚  - ã‚³ãƒ¡ãƒ³ãƒˆ                     â”‚  â”‚  - ã‚²ãƒ¼ãƒ è¨­å®š            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ãƒ¬ã‚¤ãƒ¤ãƒ¼       | æŠ€è¡“                          |
| -------------- | ----------------------------- |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | Next.js 15, React, TypeScript |
| UI Framework   | Shadcn/ui, Tailwind CSS       |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰   | Next.js Server Actions        |
| ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–   | LocalStorage / IndexedDB      |
| AI/ML          | OpenAI API (GPT-4o-mini)      |
| ãƒ‡ãƒ—ãƒ­ã‚¤       | Vercel                        |

---

## å‡¦ç†ãƒ•ãƒ­ãƒ¼

### 1. ã‚¢ãƒ—ãƒªèµ·å‹•ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant App as Next.js App
    participant LS as LocalStorage

    User->>App: ã‚¢ãƒ—ãƒªã‚¢ã‚¯ã‚»ã‚¹
    App->>LS: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    LS-->>App: ãƒ¬ãƒ™ãƒ«ã€çµ±è¨ˆã€å±¥æ­´ã€è¨­å®š
    App->>App: ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆåˆå›ã¯åˆæœŸåŒ–ï¼‰
    App-->>User: ãƒ›ãƒ¼ãƒ ç”»é¢è¡¨ç¤º
```

### 2. ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ãƒ•ãƒ­ãƒ¼

#### å…¨ä½“ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant User as ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    participant Client as Client Component
    participant SA as Server Action
    participant OpenAI as OpenAI API
    participant LS as LocalStorage

    User->>Client: ãƒ¢ãƒ¼ãƒ‰ãƒ»ã‚­ãƒ£ãƒ©é¸æŠ
    Client->>SA: ã‚²ãƒ¼ãƒ é–‹å§‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    SA->>OpenAI: åˆå›AIç™ºè¨€ç”Ÿæˆ
    OpenAI-->>SA: AIç™ºè¨€
    SA-->>Client: ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
    Client-->>User: AIç™ºè¨€è¡¨ç¤º + ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹

    loop å„ã‚¿ãƒ¼ãƒ³ (5-10å›)
        User->>Client: è¿”ç­”å…¥åŠ› + é€ä¿¡
        Client->>Client: ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ãƒ»æ™‚é–“è¨˜éŒ²
        Client->>SA: è©•ä¾¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

        par ä¸¦åˆ—å‡¦ç†
            SA->>OpenAI: ä¼šè©±ã®è³ªè©•ä¾¡
            OpenAI-->>SA: è©•ä¾¡çµæœ
        and
            SA->>OpenAI: æ¬¡ã®AIç™ºè¨€ç”Ÿæˆ
            OpenAI-->>SA: AIç™ºè¨€
        end

        SA->>SA: åå¿œé€Ÿåº¦è©•ä¾¡
        SA->>SA: ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—
        SA-->>Client: è©•ä¾¡çµæœ + æ¬¡ã®AIç™ºè¨€
        Client-->>User: ã‚¹ã‚³ã‚¢è¡¨ç¤º + æ¬¡ã®AIç™ºè¨€
    end

    Client->>SA: æœ€çµ‚ãƒªã‚¶ãƒ«ãƒˆè¨ˆç®—
    SA->>OpenAI: AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
    OpenAI-->>SA: ã‚³ãƒ¡ãƒ³ãƒˆ
    SA->>LS: ãƒ—ãƒ¬ã‚¤å±¥æ­´ä¿å­˜
    SA-->>Client: ãƒªã‚¶ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿
    Client-->>User: ãƒªã‚¶ãƒ«ãƒˆç”»é¢è¡¨ç¤º
```

#### è©³ç´°ãƒ•ãƒ­ãƒ¼ï¼ˆ1 ã‚¿ãƒ¼ãƒ³ã®å‡¦ç†ï¼‰

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å¾…æ©Ÿ
   â”‚
   â”œâ”€ ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼ˆåˆ¶é™æ™‚é–“: 3-10ç§’ï¼‰
   â”‚
   â†“
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿”ç­”é€ä¿¡
   â”‚
   â”œâ”€ ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
   â”œâ”€ è¿”ç­”æ™‚é–“è¨˜éŒ²
   â”‚
   â†“
3. Server Action å‘¼ã³å‡ºã—
   â”‚
   â”œâ”€ åå¿œé€Ÿåº¦ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆåŒæœŸï¼‰
   â”‚  â””â”€ calculateSpeedScore()
   â”‚
   â””â”€ ä¼šè©±ã®è³ªè©•ä¾¡ + æ¬¡ã®AIç™ºè¨€ç”Ÿæˆï¼ˆä¸¦åˆ—ï¼‰
      â”‚
      â”œâ”€ OpenAI API: ä¼šè©±ã®è³ªè©•ä¾¡
      â”‚  â””â”€ calculateConversationQualityScore()
      â”‚     - naturalness: 0-100
      â”‚     - empathy: 0-100
      â”‚     - topicExpansion: 0-100
      â”‚     - emotion: 0-100
      â”‚
      â””â”€ OpenAI API: æ¬¡ã®AIç™ºè¨€ç”Ÿæˆ
         â””â”€ generateAIResponse()
   â”‚
   â†“
4. ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—
   â”‚
   â”œâ”€ åå¿œé€Ÿåº¦(20%) + ä¼šè©±ã®è³ª(80%)
   â”œâ”€ ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ¤å®šï¼ˆS/A/B/C/Dï¼‰
   â”œâ”€ ã‚³ãƒ³ãƒœãƒã‚§ãƒƒã‚¯
   â”‚
   â†“
5. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”å´
   â”‚
   â”œâ”€ ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
   â”œâ”€ æ¬¡ã®AIç™ºè¨€è¡¨ç¤º
   â”œâ”€ ã‚³ãƒ³ãƒœæ¼”å‡ºï¼ˆè©²å½“æ™‚ï¼‰
   â”‚
   â†“
6. æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
```

---

## ğŸ“¡ API è¨­è¨ˆ

### Server Actions

#### 1. `startGameSession`

ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã€åˆå›ã® AI ç™ºè¨€ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```typescript
async function startGameSession(input: {
  mode: ModeId;
  character: CharacterId;
  settings: GameSettings;
}): Promise<GameSession> {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆ
  const sessionId = crypto.randomUUID();

  // åˆå›AIç™ºè¨€ç”Ÿæˆ
  const initialMessage = await generateAIResponse(
    null, // åˆå›ã¯è¿”ç­”ãªã—
    input.character,
    []
  );

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ä½œæˆ
  const session: GameSession = {
    id: sessionId,
    mode: input.mode,
    character: input.character,
    settings: input.settings,
    currentTurn: 0,
    maxTurns: input.settings.turns,
    conversationHistory: [
      {
        id: crypto.randomUUID(),
        sender: "ai",
        content: initialMessage,
        timestamp: new Date(),
      },
    ],
    combo: {
      count: 0,
      maxCombo: 0,
      threshold: 70,
      isActive: false,
    },
    aiMood: "neutral",
  };

  return session;
}
```

#### 2. `evaluateResponse`

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿”ç­”ã‚’è©•ä¾¡ã—ã€æ¬¡ã® AI ç™ºè¨€ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```typescript
async function evaluateResponse(input: {
  sessionId: string;
  playerMessage: string;
  responseTime: number;
  conversationHistory: Message[];
}): Promise<EvaluationResult> {
  const { playerMessage, responseTime, conversationHistory } = input;

  // ç›´å‰ã®AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
  const lastAIMessage = conversationHistory
    .filter((m) => m.sender === "ai")
    .slice(-1)[0]?.content;

  // ä¸¦åˆ—å‡¦ç†: è©•ä¾¡ + æ¬¡ã®AIç™ºè¨€ç”Ÿæˆ
  const [speedScore, qualityEvaluation, nextAIMessage] = await Promise.all([
    // åå¿œé€Ÿåº¦è©•ä¾¡ï¼ˆåŒæœŸå‡¦ç†ã ãŒPromiseã§ãƒ©ãƒƒãƒ—ï¼‰
    Promise.resolve(
      calculateSpeedScore(responseTime, input.session.settings.timeLimit)
    ),

    // ä¼šè©±ã®è³ªè©•ä¾¡
    calculateConversationQualityScore(
      playerMessage,
      lastAIMessage,
      conversationHistory
    ),

    // æ¬¡ã®AIç™ºè¨€ç”Ÿæˆ
    generateAIResponse(
      playerMessage,
      input.session.character,
      conversationHistory
    ),
  ]);

  // ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—
  const finalScore = await calculateFinalScore(speedScore, qualityEvaluation);

  // ã‚³ãƒ³ãƒœãƒã‚§ãƒƒã‚¯
  const combo = checkCombo(finalScore.total, input.session.combo);
  const comboMessage = getComboMessage(combo.count);

  return {
    score: finalScore,
    nextAIMessage,
    combo,
    comboMessage,
    aiComment: qualityEvaluation.comment,
  };
}
```

#### 3. `finalizeSession`

ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã€æœ€çµ‚ãƒªã‚¶ãƒ«ãƒˆã‚’è¨ˆç®—ãƒ»ä¿å­˜ã—ã¾ã™ã€‚

```typescript
async function finalizeSession(input: {
  sessionId: string;
  session: GameSession;
  allScores: ComprehensiveScore[];
}): Promise<FinalResult> {
  const { session, allScores } = input;

  // å¹³å‡ã‚¹ã‚³ã‚¢è¨ˆç®—
  const averageTotal =
    allScores.reduce((sum, s) => sum + s.total, 0) / allScores.length;

  const averageBreakdown = {
    naturalness:
      allScores.reduce((sum, s) => sum + s.breakdown.naturalness, 0) /
      allScores.length,
    empathy:
      allScores.reduce((sum, s) => sum + s.breakdown.empathy, 0) /
      allScores.length,
    topicExpansion:
      allScores.reduce((sum, s) => sum + s.breakdown.topicExpansion, 0) /
      allScores.length,
    emotion:
      allScores.reduce((sum, s) => sum + s.breakdown.emotion, 0) /
      allScores.length,
  };

  // æœ€çµ‚ã‚°ãƒ¬ãƒ¼ãƒ‰
  let grade: "S" | "A" | "B" | "C" | "D";
  if (averageTotal >= 90) grade = "S";
  else if (averageTotal >= 75) grade = "A";
  else if (averageTotal >= 60) grade = "B";
  else if (averageTotal >= 45) grade = "C";
  else grade = "D";

  // AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
  const aiComment = await generateAIComment(
    {
      total: Math.round(averageTotal),
      speed: allScores.reduce((sum, s) => sum + s.speed, 0) / allScores.length,
      conversationQuality:
        allScores.reduce((sum, s) => sum + s.conversationQuality, 0) /
        allScores.length,
      breakdown: averageBreakdown,
      grade,
    },
    session.character,
    session.conversationHistory[session.conversationHistory.length - 1].content
  );

  // çµŒé¨“å€¤è¨ˆç®—
  const experience = calculateExperience({
    total: Math.round(averageTotal),
    speed: 0,
    conversationQuality: 0,
    breakdown: averageBreakdown,
    grade,
  });

  // LocalStorageã«ä¿å­˜
  await savePlayHistoryToLocal({
    sessionId: input.sessionId,
    mode: session.mode,
    character: session.character,
    averageScore: Math.round(averageTotal),
    breakdown: averageBreakdown,
    grade,
    maxCombo: session.combo.maxCombo,
    experience,
    playedAt: new Date(),
  });

  // ç§°å·ãƒã‚§ãƒƒã‚¯
  const newAchievements = await checkAchievements();

  return {
    sessionId: input.sessionId,
    averageScore: Math.round(averageTotal),
    breakdown: averageBreakdown,
    grade,
    aiComment,
    maxCombo: session.combo.maxCombo,
    experience,
    newAchievements,
  };
}
```

### OpenAI API å‘¼ã³å‡ºã—

#### 1. ä¼šè©±ç”Ÿæˆ

```typescript
async function generateAIResponse(
  playerMessage: string | null,
  character: Character,
  conversationHistory: Message[]
): Promise<string> {
  const systemPrompt = `
ã‚ãªãŸã¯${character.name}ã§ã™ã€‚
æ€§æ ¼: ${character.description}

ã€ä¼šè©±ã®ãƒ«ãƒ¼ãƒ«ã€‘
1. ${character.responseStyle}ãªã‚¹ã‚¿ã‚¤ãƒ«ã§è¿”ç­”
2. è‡ªç„¶ãªä¼šè©±ã‚’å¿ƒãŒã‘ã‚‹
3. é©åº¦ã«è³ªå•ã‚‚å…¥ã‚Œã‚‹
4. 50æ–‡å­—ä»¥å†…ã§è¿”ç­”
5. çµµæ–‡å­—ã¯æ§ãˆã‚ã«ï¼ˆ1-2å€‹ï¼‰
`;

  const messages = [
    { role: "system", content: systemPrompt },
    ...conversationHistory.map((m) => ({
      role: m.sender === "ai" ? "assistant" : "user",
      content: m.content,
    })),
  ];

  if (playerMessage) {
    messages.push({ role: "user", content: playerMessage });
  }

  const response = await openai.chat.completions.create({
    model: "gpt-4o-mini",
    messages,
    temperature: 0.8,
    max_tokens: 100,
  });

  return response.choices[0].message.content?.trim() || "...";
}
```

#### 2. ä¼šè©±ã®è³ªè©•ä¾¡

ï¼ˆai-evaluation-design.md ã‚’å‚ç…§ï¼‰

#### 3. AI ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ

ï¼ˆai-evaluation-design.md ã‚’å‚ç…§ï¼‰

---

## ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆ

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

#### 1. `userData` - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

```typescript
type UserData = {
  id: string; // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDï¼ˆåˆå›ç”Ÿæˆï¼‰
  name: string; // è¡¨ç¤ºåï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  level: number; // ãƒ¬ãƒ™ãƒ«
  experience: number; // çµŒé¨“å€¤
  createdAt: string; // ä½œæˆæ—¥æ™‚
  updatedAt: string; // æ›´æ–°æ—¥æ™‚
};

// LocalStorage Key: "kaiwa-dash-user"
```

#### 2. `playHistory` - ãƒ—ãƒ¬ã‚¤å±¥æ­´

```typescript
type PlayHistory = {
  sessionId: string;
  mode: ModeId;
  character: CharacterId;
  averageScore: number; // 0-100
  breakdown: {
    naturalness: number;
    empathy: number;
    topicExpansion: number;
    emotion: number;
  };
  grade: "S" | "A" | "B" | "C" | "D";
  maxCombo: number;
  experience: number;
  playedAt: string; // ISO 8601
};

// LocalStorage Key: "kaiwa-dash-history"
// ãƒ‡ãƒ¼ã‚¿å½¢å¼: PlayHistory[]
```

#### 3. `achievements` - ç§°å·

```typescript
type UserAchievement = {
  achievementId: string; // 'speed-ninja', 'empathy-master', etc.
  unlockedAt: string; // ISO 8601
};

// LocalStorage Key: "kaiwa-dash-achievements"
// ãƒ‡ãƒ¼ã‚¿å½¢å¼: UserAchievement[]
```

#### 4. `settings` - ã‚²ãƒ¼ãƒ è¨­å®š

```typescript
type GameSettings = {
  defaultTurns: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ãƒ³æ•°ï¼ˆ5/10/15ï¼‰
  defaultTimeLimit: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ¶é™æ™‚é–“ï¼ˆ3-10ç§’ï¼‰
  inputMethod: "text" | "voice"; // å…¥åŠ›æ–¹æ³•
  soundVolume: number; // éŸ³é‡ï¼ˆ0-100ï¼‰
  vibrationEnabled: boolean; // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  notificationEnabled: boolean; // é€šçŸ¥
  notificationTime: string; // é€šçŸ¥æ™‚åˆ»ï¼ˆHH:mmï¼‰
};

// LocalStorage Key: "kaiwa-dash-settings"
```

### ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•°

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ãƒ»å–å¾—

```typescript
function initializeUser(): UserData {
  const existingUser = localStorage.getItem("kaiwa-dash-user");
  if (existingUser) {
    return JSON.parse(existingUser);
  }

  const newUser: UserData = {
    id: crypto.randomUUID(),
    name: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼",
    level: 1,
    experience: 0,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  };

  localStorage.setItem("kaiwa-dash-user", JSON.stringify(newUser));
  return newUser;
}

function updateUserLevel(experience: number): {
  level: number;
  isLevelUp: boolean;
} {
  const userData = initializeUser();
  const oldLevel = userData.level;

  // ãƒ¬ãƒ™ãƒ«è¨ˆç®—ï¼ˆ100XPã”ã¨ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼‰
  const newLevel = Math.floor(experience / 100) + 1;
  const isLevelUp = newLevel > oldLevel;

  userData.level = newLevel;
  userData.experience = experience;
  userData.updatedAt = new Date().toISOString();

  localStorage.setItem("kaiwa-dash-user", JSON.stringify(userData));

  return { level: newLevel, isLevelUp };
}
```

#### ãƒ—ãƒ¬ã‚¤å±¥æ­´ã®ä¿å­˜ãƒ»å–å¾—

```typescript
function savePlayHistoryToLocal(playData: PlayHistory): void {
  const history = getPlayHistory();
  history.unshift(playData); // æ–°ã—ã„ã‚‚ã®ã‚’å…ˆé ­ã«

  // æœ€å¤§100ä»¶ã¾ã§ä¿å­˜ï¼ˆãƒ¡ãƒ¢ãƒªç¯€ç´„ï¼‰
  const trimmedHistory = history.slice(0, 100);

  localStorage.setItem("kaiwa-dash-history", JSON.stringify(trimmedHistory));
}

function getPlayHistory(): PlayHistory[] {
  const stored = localStorage.getItem("kaiwa-dash-history");
  return stored ? JSON.parse(stored) : [];
}

function getPlayHistoryByMode(mode: ModeId): PlayHistory[] {
  const history = getPlayHistory();
  return history.filter((h) => h.mode === mode);
}
```

#### ç§°å·ã®ç®¡ç†

```typescript
function unlockAchievement(achievementId: string): boolean {
  const achievements = getAchievements();

  // æ—¢ã«è§£é™¤æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
  if (achievements.some((a) => a.achievementId === achievementId)) {
    return false;
  }

  achievements.push({
    achievementId,
    unlockedAt: new Date().toISOString(),
  });

  localStorage.setItem("kaiwa-dash-achievements", JSON.stringify(achievements));
  return true; // æ–°è¦è§£é™¤
}

function getAchievements(): UserAchievement[] {
  const stored = localStorage.getItem("kaiwa-dash-achievements");
  return stored ? JSON.parse(stored) : [];
}
```

### ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

```typescript
// å…¨ãƒ‡ãƒ¼ã‚¿ã‚’JSONã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportAllData(): string {
  const data = {
    user: localStorage.getItem("kaiwa-dash-user"),
    history: localStorage.getItem("kaiwa-dash-history"),
    achievements: localStorage.getItem("kaiwa-dash-achievements"),
    settings: localStorage.getItem("kaiwa-dash-settings"),
    exportedAt: new Date().toISOString(),
  };

  return JSON.stringify(data, null, 2);
}

// JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
function importAllData(jsonData: string): void {
  try {
    const data = JSON.parse(jsonData);

    if (data.user) localStorage.setItem("kaiwa-dash-user", data.user);
    if (data.history) localStorage.setItem("kaiwa-dash-history", data.history);
    if (data.achievements)
      localStorage.setItem("kaiwa-dash-achievements", data.achievements);
    if (data.settings)
      localStorage.setItem("kaiwa-dash-settings", data.settings);

    alert("ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ");
    window.location.reload();
  } catch (error) {
    console.error("Import failed:", error);
    alert("ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}
```

### ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆ

```typescript
function resetAllData(): void {
  if (confirm("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
    localStorage.removeItem("kaiwa-dash-user");
    localStorage.removeItem("kaiwa-dash-history");
    localStorage.removeItem("kaiwa-dash-achievements");
    // è¨­å®šã¯ä¿æŒ

    alert("ãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ");
    window.location.reload();
  }
}
```

---

## ğŸ¨ çŠ¶æ…‹ç®¡ç†

### Client Component ã®çŠ¶æ…‹

```typescript
type GameState = {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
  sessionId: string;
  mode: ModeId;
  character: Character;
  settings: GameSettings;

  // ã‚¿ãƒ¼ãƒ³æƒ…å ±
  currentTurn: number;
  maxTurns: number;

  // ä¼šè©±å±¥æ­´
  conversationHistory: Message[];

  // ã‚¿ã‚¤ãƒãƒ¼
  timeLimit: number;
  remainingTime: number;
  timerStartedAt: Date | null;

  // ã‚¹ã‚³ã‚¢
  turnScores: ComprehensiveScore[];
  currentTurnScore: ComprehensiveScore | null;

  // ã‚³ãƒ³ãƒœ
  combo: ComboState;

  // UIçŠ¶æ…‹
  isLoading: boolean;
  isTimerActive: boolean;
  showScoreAnimation: boolean;
  aiMood: "happy" | "neutral" | "bored" | "surprised";
};
```

### LocalStorage ã®åˆ©ç”¨

ã‚²ãƒ¼ãƒ è¨­å®šãªã©ã®éé‡è¦ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚

```typescript
// è¨­å®šã®ä¿å­˜
function saveSettings(settings: GameSettings) {
  localStorage.setItem("kaiwa-dash-settings", JSON.stringify(settings));
}

// è¨­å®šã®èª­ã¿è¾¼ã¿
function loadSettings(): GameSettings {
  const stored = localStorage.getItem("kaiwa-dash-settings");
  if (stored) {
    return JSON.parse(stored);
  }
  return defaultSettings;
}
```

---

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. API å‘¼ã³å‡ºã—ã®æœ€é©åŒ–

```typescript
// ä¸¦åˆ—å‡¦ç†ã§è©•ä¾¡ã¨æ¬¡ã®AIç™ºè¨€ã‚’åŒæ™‚å–å¾—
const [qualityEvaluation, nextAIMessage] = await Promise.all([
  calculateConversationQualityScore(playerMessage, aiMessage, history),
  generateAIResponse(playerMessage, character, history),
]);
```

### 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```typescript
// ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const characterCache = new Map<CharacterId, Character>();

function getCharacter(id: CharacterId): Character {
  if (!characterCache.has(id)) {
    characterCache.set(id, loadCharacterConfig(id));
  }
  return characterCache.get(id)!;
}
```

### 3. Streaming UI

ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ãŸã‚ã«ã€Streaming ã‚’æ´»ç”¨ã—ã¾ã™ã€‚

```typescript
// AIç™ºè¨€ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
async function* streamAIResponse(
  playerMessage: string,
  character: Character,
  history: Message[]
) {
  const stream = await openai.chat.completions.create({
    model: "gpt-4o-mini",
    messages: buildMessages(playerMessage, character, history),
    stream: true,
  });

  for await (const chunk of stream) {
    const content = chunk.choices[0]?.delta?.content;
    if (content) {
      yield content;
    }
  }
}
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1. Unit Tests (Vitest)

```typescript
// è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ
describe("calculateSpeedScore", () => {
  it("should return 100 for responses within 50% of time limit", () => {
    expect(calculateSpeedScore(2, 5)).toBe(100);
  });

  it("should return 20 for timeout", () => {
    expect(calculateSpeedScore(6, 5)).toBe(20);
  });
});
```

### 2. Integration Tests (React Testing Library)

```typescript
// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
describe("ConversationPlay", () => {
  it("should start timer when AI message is displayed", () => {
    render(<ConversationPlay session={mockSession} />);
    expect(screen.getByText(/â±ï¸/)).toBeInTheDocument();
  });

  it("should submit response and show score", async () => {
    render(<ConversationPlay session={mockSession} />);
    const input = screen.getByPlaceholderText("ã‚ãªãŸã®è¿”ç­”ã‚’å…¥åŠ›...");
    fireEvent.change(input, { target: { value: "test message" } });
    fireEvent.click(screen.getByText("é€ä¿¡"));

    await waitFor(() => {
      expect(screen.getByText(/ã‚¹ã‚³ã‚¢/)).toBeInTheDocument();
    });
  });
});
```

### 3. E2E Tests (Playwright)

```typescript
// å®Œå…¨ãªã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
test("should complete a full game session", async ({ page }) => {
  await page.goto("/");
  await page.click('text="ãƒ—ãƒ¬ã‚¤é–‹å§‹"');
  await page.click('text="é›‘è«‡ã‚¹ãƒ—ãƒªãƒ³ãƒˆ"');
  await page.click('text="çœŸé¢ç›®ãã‚“"');
  await page.click('text="ã‚¹ã‚¿ãƒ¼ãƒˆï¼"');

  // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤
  for (let i = 0; i < 5; i++) {
    await page.fill(
      'input[placeholder="ã‚ãªãŸã®è¿”ç­”ã‚’å…¥åŠ›..."]',
      "test message"
    );
    await page.click('button:has-text("é€ä¿¡")');
    await page.waitForSelector('text="ã‚¹ã‚³ã‚¢"');
  }

  // ãƒªã‚¶ãƒ«ãƒˆç¢ºèª
  await page.waitForSelector('text="ãƒªã‚¶ãƒ«ãƒˆ"');
  expect(await page.textContent("h1")).toContain("ãƒ©ãƒ³ã‚¯");
});
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥

### Vercel ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆVercel Dashboardï¼‰
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
OPENAI_API_KEY=your_openai_api_key

# ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod
```

### ç’°å¢ƒåˆ¥è¨­å®š

| ç’°å¢ƒ        | URL                              | ç”¨é€”                |
| ----------- | -------------------------------- | ------------------- |
| Production  | https://kaiwa-dash.vercel.app    | æœ¬ç•ªç’°å¢ƒ            |
| Preview     | https://kaiwa-dash-\*.vercel.app | PR ã”ã¨ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ |
| Development | http://localhost:3000            | ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º        |

---

## ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### 1. ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

```typescript
// Sentryçµ±åˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
});

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
try {
  await evaluateResponse(input);
} catch (error) {
  Sentry.captureException(error);
  throw error;
}
```

### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```typescript
// ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
export async function evaluateResponse(input: EvaluationInput) {
  const start = Date.now();

  try {
    const result = await evaluateResponseInternal(input);
    const duration = Date.now() - start;

    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²
    console.log(`[PERF] evaluateResponse took ${duration}ms`);

    return result;
  } catch (error) {
    const duration = Date.now() - start;
    console.error(`[PERF] evaluateResponse failed after ${duration}ms`);
    throw error;
  }
}
```
