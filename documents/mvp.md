# MVP 実装計画 - 会話ダッシュ

## 概要

MVP（Minimum Viable Product）では、**コア機能に絞って素早く動くプロトタイプを作成**します。
まずは 1 つのモードとキャラクターで基本的なゲームループを実装し、段階的に機能を追加していきます。

---

## MVP の目標

1. **ゲームの核となる体験を提供**

   - AI との会話練習
   - リアルタイム評価
   - スコア表示

2. **技術検証**

   - OpenAI API との統合
   - Next.js Server Actions の動作確認
   - ローカルストレージの活用

3. **早期フィードバック**
   - ユーザーテストで改善点を洗い出す
   - コンセプトの有効性を検証

---

## フェーズ別実装計画

### Phase 1: 基本ゲームループ（MVP Core）

**目標:** 最小限の機能で動くプロトタイプを完成させる

#### 実装する機能

| 機能                      | 説明                               | 優先度 |
| ------------------------- | ---------------------------------- | ------ |
| 1 モード × 1 キャラクター | 雑談スプリント × 真面目くんのみ    | 🔴 高  |
| 会話プレイ画面            | AI との会話、タイマー、返答入力    | 🔴 高  |
| 反応速度評価              | ルールベースの速度スコア計算       | 🔴 高  |
| AI 評価（簡易版）         | OpenAI API で会話の質を評価        | 🔴 高  |
| リザルト画面              | スコアと簡単なコメント表示         | 🔴 高  |
| ローカルストレージ        | プレイ履歴の保存（最新 10 件のみ） | 🔴 高  |

#### 実装しない機能

- モード選択（1 モード固定）
- キャラクター選択（1 キャラ固定）
- ホーム画面（すぐプレイ開始）
- 統計・成長画面
- 称号システム
- レベルシステム
- 設定画面
- コンボ演出

#### 画面構成（MVP）

```
Phase 1 の画面:
1. プレイ画面（メイン）
2. リザルト画面
```

#### 技術スタック（MVP）

```
- Next.js 15 (App Router)
- TypeScript
- Tailwind CSS（カスタムコンポーネント、Shadcn/ui は後回し）
- OpenAI API (gpt-4o-mini)
- LocalStorage
```

#### データ構造（MVP）

```typescript
// ローカルストレージに保存
type MVPPlayHistory = {
  sessionId: string;
  score: number;
  playedAt: string;
};

// LocalStorage Key: "kaiwa-dash-mvp-history"
```

---

### Phase 2: UX 改善（MVP+）

**目標:** ユーザー体験を向上させ、継続利用を促進

#### 追加する機能

| 機能                 | 説明                                   | 優先度 |
| -------------------- | -------------------------------------- | ------ |
| ホーム画面           | ウェルカム画面 + プレイ開始ボタン      | 🟡 中  |
| モード選択（4 種類） | 初対面・雑談・ピンチ・フリートーク     | 🟡 中  |
| キャラ選択（4 種類） | 真面目・明るい・オタク・冷静           | 🟡 中  |
| 統計画面             | プレイ履歴の一覧、平均スコア           | 🟡 中  |
| スコアアニメーション | カウントアップ演出                     | 🟢 低  |
| コンボ演出           | 3 ターン連続高評価で「トークコンボ！」 | 🟢 低  |
| タイマー演出         | 残り時間で色変化（緑 → 黄 → 赤）       | 🟡 中  |

#### 画面構成（Phase 2）

1. ホーム画面
2. モード＆キャラ選択画面
3. プレイ画面
4. リザルト画面
5. 統計画面

---

### Phase 3: ゲーミフィケーション

**目標:** 長期的なモチベーションを維持する仕組みを追加

#### 追加する機能

| 機能             | 説明                                 | 優先度 |
| ---------------- | ------------------------------------ | ------ |
| レベルシステム   | 経験値でレベルアップ                 | 🟡 中  |
| 称号システム     | 条件達成で称号解除                   | 🟡 中  |
| 設定画面         | ゲーム設定、データエクスポート       | 🟡 中  |
| スコア推移グラフ | 過去 7 日間の平均スコアを可視化      | 🟢 低  |
| AI の表情変化    | プレイヤーの返答に応じて表情が変わる | 🟢 低  |

#### 画面構成（Phase 3）

1. ホーム画面（レベル表示追加）
2. モード＆キャラ選択画面
3. プレイ画面（表情変化追加）
4. リザルト画面（称号解除演出追加）
5. 統計画面（グラフ追加）
6. 設定画面（新規）

---

### Phase 4: ポリッシュ & 最適化

**目標:** プロダクションレディな状態にする

#### 追加する機能

| 機能                 | 説明                            | 優先度 |
| -------------------- | ------------------------------- | ------ |
| Shadcn/ui 統合       | UI コンポーネントを統一         | 🟡 中  |
| ダークモード         | ライト/ダークテーマ切り替え     | 🟢 低  |
| レスポンシブ対応     | タブレット・デスクトップ対応    | 🟡 中  |
| エラーハンドリング   | API エラー時の適切な処理        | 🔴 高  |
| ローディング状態     | Suspense, Skeleton を使った UX  | 🟡 中  |
| パフォーマンス最適化 | 画像最適化、コード分割          | 🟡 中  |
| E2E テスト           | Playwright で主要フローをテスト | 🟢 低  |

## Phase 1 (MVP Core) 詳細設計

### 画面設計

#### 1. プレイ画面（簡易版）

```
┌─────────────────────────────────────┐
│  会話ダッシュ MVP                    │
├─────────────────────────────────────┤
│                                     │
│  ターン 3/5                          │
│                                     │
│  ┌────────────────────────┐       │
│  │ 昨日寝不足でさ〜         │       │
│  │ [AI]                   │       │
│  └────────────────────────┘       │
│                                     │
│  ┌────────────────────────┐       │
│  │ わかる！俺も3時まで      │       │
│  │ [You]                  │       │
│  └────────────────────────┘       │
│                                     │
│  ⏱️ ████████░░  残り 3 秒         │
│                                     │
│  ┌────────────────────────┐       │
│  │ あなたの返答...          │       │
│  │                   [送信] │       │
│  └────────────────────────┘       │
│                                     │
└─────────────────────────────────────┘
```

#### 2. リザルト画面（簡易版）

```
┌─────────────────────────────────────┐
│  リザルト                            │
├─────────────────────────────────────┤
│                                     │
│         総合スコア                   │
│         ─────────                   │
│           ★ 78点 ★                │
│                                     │
│  ⚡ 反応速度:    85点                │
│  💬 会話の質:    76点                │
│                                     │
│  AI からのコメント:                  │
│  「テンポ良かったよ！                │
│   もう少し質問を入れてみよう」        │
│                                     │
│  ┌────────────────────────┐       │
│  │      もう一度            │       │
│  └────────────────────────┘       │
│                                     │
└─────────────────────────────────────┘
```

### API 設計（MVP）

#### Server Actions（簡易版）

```typescript
// 1. ゲームセッション開始
async function startMVPSession(): Promise<{
  sessionId: string;
  firstMessage: string;
}> {
  const sessionId = crypto.randomUUID();
  const firstMessage = await generateAIMessage(null, []);

  return { sessionId, firstMessage };
}

// 2. 返答評価
async function evaluateMVPResponse(input: {
  playerMessage: string;
  responseTime: number;
  conversationHistory: string[];
}): Promise<{
  speedScore: number;
  qualityScore: number;
  totalScore: number;
  nextMessage: string;
}> {
  // 並列処理
  const [speedScore, qualityScore, nextMessage] = await Promise.all([
    Promise.resolve(calculateSpeedScore(input.responseTime, 5)),
    evaluateQualitySimple(input.playerMessage),
    generateAIMessage(input.playerMessage, input.conversationHistory),
  ]);

  const totalScore = Math.round(speedScore * 0.2 + qualityScore * 0.8);

  return { speedScore, qualityScore, totalScore, nextMessage };
}

// 3. セッション終了
async function finalizeMVPSession(input: {
  sessionId: string;
  scores: number[];
}): Promise<{
  averageScore: number;
  comment: string;
}> {
  const averageScore = Math.round(
    scores.reduce((sum, s) => sum + s, 0) / scores.length
  );

  const comment = await generateSimpleComment(averageScore);

  // ローカルストレージに保存（クライアント側）
  return { averageScore, comment };
}
```

### 実装チェックリスト

#### セットアップ

- [ ] Next.js プロジェクト作成
- [ ] TypeScript 設定
- [ ] Tailwind CSS セットアップ
- [ ] OpenAI SDK インストール
- [ ] 環境変数設定（OPENAI_API_KEY）

#### プレイ画面

- [ ] タイマーコンポーネント
- [ ] メッセージ表示エリア
- [ ] 入力フォーム
- [ ] ターン管理ロジック
- [ ] 会話履歴の状態管理

#### 評価ロジック

- [ ] 反応速度計算関数
- [ ] OpenAI API 呼び出し
- [ ] 会話の質評価プロンプト作成
- [ ] エラーハンドリング

#### リザルト画面

- [ ] スコア表示
- [ ] AI コメント表示
- [ ] もう一度ボタン

#### データ永続化

- [ ] ローカルストレージ保存関数
- [ ] ローカルストレージ読み込み関数

#### テスト

- [ ] 手動テスト（5 回プレイ）
- [ ] OpenAI API のレスポンス確認
- [ ] ローカルストレージの動作確認

---

## 成功指標（KPI）

### Phase 1 (MVP)

- ✅ 5 ターンのゲームが最後まで動作する
- ✅ OpenAI API のエラー率 < 5%
- ✅ 評価が適切に表示される
- ✅ ローカルストレージにデータが保存される

### Phase 2 (MVP+)

- ✅ 4 モード × 4 キャラが全て動作
- ✅ ユーザーが 3 回以上プレイ
- ✅ 平均プレイ時間: 3-5 分

### Phase 3 (ゲーミフィケーション)

- ✅ ユーザーが 10 回以上プレイ
- ✅ 称号を 1 つ以上解除
- ✅ レベル 3 以上到達

---

## 実装のポイント

### 1. MVP では完璧を目指さない

- UI は最小限で OK（後で改善）
- エラーハンドリングは基本的なもののみ
- パフォーマンスチューニングは後回し

### 2. OpenAI API の使い方

```typescript
// MVP: シンプルなプロンプト
const systemPrompt = `
あなたは友達として自然な会話をしてください。
50文字以内で返答してください。
`;

// Phase 2: キャラクターごとのプロンプト
const systemPrompt = `
あなたは${character.name}です。
性格: ${character.description}
...
`;
```

### 3. 段階的な改善

```text
MVP → 動くプロトタイプ
  ↓
Phase 2 → UX 改善
  ↓
Phase 3 → 機能追加
  ↓
Phase 4 → 品質向上
```

---

## 技術的な課題と対策

### 課題 1: OpenAI API のレスポンス時間

**問題:** API 呼び出しに 2-3 秒かかる

**対策:**

- ローディング状態を表示
- Streaming API を活用（Phase 2 以降）
- 並列処理で評価と次の発言を同時取得

### 課題 2: ローカルストレージの容量制限

**問題:** 5-10MB の制限

**対策:**

- プレイ履歴は最新 100 件まで
- 会話履歴は保存しない（スコアのみ）
- 必要に応じて IndexedDB に移行（Phase 3 以降）

### 課題 3: AI 評価の精度

**問題:** 評価がバラつく

**対策:**

- temperature を低めに設定（0.3）
- JSON モードで構造化された出力
- フォールバック値を用意（50 点）

---

## ✅ MVP チェックリスト

### 開発開始前

- [ ] 要件定義レビュー
- [ ] 技術スタック確認
- [ ] OpenAI API キー取得
- [ ] 開発環境セットアップ

### Phase 1 開発中

- [ ] プロジェクト初期化
- [ ] UI コンポーネント実装
- [ ] OpenAI API 統合
- [ ] 評価ロジック実装
- [ ] ローカルストレージ実装

### Phase 1 完了時

- [ ] 手動テスト（5 ターン × 3 回）
- [ ] エラーケース確認
- [ ] パフォーマンス確認
- [ ] Alpha リリース準備
